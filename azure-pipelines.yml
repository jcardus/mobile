# Xcode
trigger:
- mobile-dev

pool:
  vmImage: 'macos-latest'

variables:
  - name: FASTLANE_PASSWORD
    value: $(FASTLANE_PASS)
  - name: FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD
    value: $(FASTLANE_APP_SPECIFIC)

steps:
- task: InstallAppleCertificate@2
  inputs:
    certSecureFile: ios-dev.p12

- task: InstallAppleProvisioningProfile@1
  inputs:
    provisioningProfileLocation: 'secureFiles' # Options: secureFiles, sourceRepository
    provProfileSecureFile: 'azuredevops.mobileprovision'
    removeProfile: true # Optional

- task: DownloadSecureFile@1
  name: provProfile
  displayName: 'Download profile'
  inputs:
    secureFile: 'azuredevops.mobileprovision'

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      echo using profile $(provProfile.secureFilePath)
      npm install

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      echo using profile $(provProfile.secureFilePath)
      npm run-script deploy:ios:localizalia:beta
      cp mobile/Gemfile* ios/App
      cd ios/App
      gem install bundler
      bundle install
      gem install xcodeproj
      ruby addGooglePlist.rb
      echo "add_plugin versioning"
      bundle exec fastlane add_plugin versioning
      bundle exec fastlane install_plugins
      export PACKAGE_VERSION=$(cat package.json \
        | grep version \
        | head -1 \
        | awk -F: '{ print $2 }' \
        | sed 's/[",]//g')
      echo $PACKAGE_VERSION
      echo "package_name(\"$PACKAGE_NAME\")" >> fastlane/Appfile
      echo "apple_id(\"admin@fleetmap.io\")" >> fastlane/Appfile
      echo "itc_team_id(\"122303819\")" >> fastlane/Appfile
      echo "team_id(\"57X9MD32BX\")" >> fastlane/Appfile
      echo "Appfile"
      export FL_PROJECT_PROVISIONING_PROFILE_FILE=$(provProfile.secureFilePath)
      bundle exec fastlane beta

